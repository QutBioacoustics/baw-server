---
# tasks file for audio_tools

#
# Required binaries
#
- name: Install base dependencies (imagemagick)
  apt: name=imagemagick state=present
  become: yes

- name: Install base dependencies (wavpack)
  apt: name=wavpack state=present
  become: yes

- name: Install base dependencies (libsox-fmt-all)
  apt: name=libsox-fmt-all state=present
  become: yes

- name: Install base dependencies (sox)
  apt: name=sox state=present
  become: yes

- name: Install base dependencies (shntool)
  apt: name=shntool state=present
  become: yes

- name: Install base dependencies (mp3splt)
  apt: name=mp3splt state=present
  become: yes

- name: Install base dependencies (libav-tools)
  apt: name=libav-tools state=present
  become: yes

#
# More binaries
#
- name: Install base dependencies (g++)
  apt: name='g++' state=latest
  become: yes

- name: Install base dependencies (libsndfile1-dev)
  apt: name='libsndfile1-dev' state=latest
  become: yes

# TODO: These libraries are no longer available in ubuntu 16.04+
- name: Install base dependencies (libpng++-dev
  apt: name='libpng++-dev' state=latest
  become: yes

- name: Install base dependencies (libpng12-dev)
  apt: name='libpng12-dev' state=latest
  become: yes

- name: Install base dependencies (libboost-program-options-dev)
  apt: name='libboost-program-options-dev' state=latest
  become: yes

#
# Install ffmpeg, it is special
#

- name: APT | Add key for custom ppa
  apt_key:
    url: http://keyserver.ubuntu.com/pks/lookup?op=get&fingerprint=on&search=0x8C1EA520
    state: present
  become: true

# Add support for https apt
- name: APT | Add support for APT over HTTPS
  apt:
    name: '{{item}}'
    state: present
  become: true
  with_items:
    - apt-transport-https
    - ca-certificates

# Add the ffmpeg APT repository
# https://launchpad.net/~mc3man/+archive/ubuntu/trusty-media
# This method should only be used for ubuntu 14.04
- name: APT | Add ffmpeg's APT repository
  apt_repository:
    repo: 'ppa:mc3man/trusty-media'
    state: present
    update_cache: yes
  become: true

# Finally install (install once only)
- name: APT | Install ffmpeg
  apt:
    name: ffmpeg
    state: present
    update_cache: true
  become: true

# an APT install puts ffmpeg in /usr/bin - we need to make sure ffmpeg is installed in /usr/bin/local
# as well for legacy reasons
- name: SET_FACT | Update ffmpeg aliases variable
  set_fact:
    ffmpeg_aliases:
      - '/usr/local/bin'

- name: FILE | Create ffmpeg alias directories
  file:
    path: "{{ item }}"
    state: directory
  with_items: "{{ ffmpeg_aliases }}"
  become: true

- name: FILE | Aliasing ffmpeg binaries
  file:
    src: /usr/bin/{{ item[0] }}
    dest: "{{ item[1] }}/{{ item[0] }}"
    state: link
  with_nested:
    - [ ffmpeg, ffprobe ]
    - "{{ ffmpeg_aliases }}"
  become: true

#
# install wav2png
#
- name: downloads/wav2png folder creation
  file: path=/home/vagrant/downloads/wav2png state=directory
  tags: wav2png

- name: Get wav2png source
  git:
    dest: '/home/vagrant/downloads/wav2png'
    repo: 'https://github.com/beschulz/wav2png.git'
  register: wav2png_result
  tags: wav2png

- name: Building wav2png binaries
  command: make -C ./build all BINARY='/home/vagrant/downloads/wav2png.build'
  args:
    creates: '/home/vagrant/downloads/wav2png.build'
    chdir: '/home/vagrant/downloads/wav2png'
  when: wav2png_result.changed
  tags: wav2png

- name: Copying wav2png binaries
  command: "cp /home/vagrant/downloads/wav2png.build /usr/local/bin/wav2png"
  become: true
  when: wav2png_result.changed
  tags: wav2png

